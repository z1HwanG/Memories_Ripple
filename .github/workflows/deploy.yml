name: Deploy Hugo Site  # å·¥ä½œæµçš„åç§°ï¼Œæ˜¾ç¤ºåœ¨GitHub Actionsç•Œé¢ä¸Š

on:  # è§¦å‘å·¥ä½œæµçš„æ¡ä»¶
  push:  # å½“æœ‰ä»£ç æ¨é€æ—¶
    branches:
      - main  # ä»…å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘

jobs:  # å·¥ä½œæµä¸­çš„ä½œä¸š
  deploy:
    runs-on: huawei
    steps:
      - name: Start Deployment Notification
        run: echo "ğŸš€ å¼€å§‹éƒ¨ç½² Hugo ç½‘ç«™åˆ°æœåŠ¡å™¨..."
        
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Build Hugo site
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true
          
      - name: Build site
        run: hugo --minify
        
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 1panel.z1hwang.cn
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/1panel/apps/openresty/openresty/www/sites/blog.z1hwang.cn/index
            echo "ğŸ”„ æ­£åœ¨å‡†å¤‡ç›®æ ‡ç›®å½•..."
            # æ‹‰å–è¿œç¨‹ä»“åº“æ›´æ–°ï¼ˆå¦‚æœæ˜¯Gitä»“åº“ï¼‰
            # git pull
            # æˆ–è€…æ¸…ç©ºç›®å½•å‡†å¤‡æ¥æ”¶æ–°æ–‡ä»¶
            rm -rf * .[^.]*

      - name: Upload Hugo public files
        uses: appleboy/scp-action@master
        with:
          host: 1panel.z1hwang.cn
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "public/"
          target: "/opt/1panel/apps/openresty/openresty/www/sites/blog.z1hwang.cn/index"
          strip_components: 1
          
      - name: Final server adjustments
        uses: appleboy/ssh-action@master
        with:
          host: 1panel.z1hwang.cn
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/1panel/apps/openresty/openresty/www/sites/blog.z1hwang.cn/index
            echo "ğŸ”§ æ­£åœ¨è®¾ç½®æ–‡ä»¶æƒé™..."
            # æ‰§è¡Œä»»ä½•éœ€è¦çš„åç»­å‘½ä»¤ï¼Œä¾‹å¦‚è®¾ç½®æƒé™ç­‰
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;
            echo "âœ… ç½‘ç«™éƒ¨ç½²å®Œæˆï¼"
            
      - name: Deployment Completion
        run: echo "âœ… Hugo ç½‘ç«™å·²æˆåŠŸéƒ¨ç½²åˆ° 1panel.z1hwang.cn"
